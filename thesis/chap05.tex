\chapter{Simplificação de Superfícies baseadas em \textit{Splats}}
Neste capítulo apresentaremos um algoritmo para simplificação de superfícies
representada por \textit{splats}. Utilizamos uma abordagem incremental, onde clusters
são criados sistematicamente ao crescer regiões através da agregação de
\textit{splats} vizinhos. Este crescimento é guiado por dois erros: o
\textit{erro perpendicular}, que mede a variação dos \textit{splats} na direção
da normal; e o \textit{erro tangencial}, que nos fornece uma medida de
cobertura. Partiremos da suposição de que o modelo já possui um representação
em \textit{splats} e que inicialmente todos são \textit{splats} circulares.

\section{Motivação}
Como mencionado no capítulo~\ref{cap04}, modelos baseados em pontos
são complexos devido à grande quantidade de amostras necessárias para
representá-lo, tornando operações de simplificação uma ferramenta necessária para
que seja possível alcançar taxas interativas de processamento e visualização;
\texit{splats} são muitos usados no contexto de renderização quando se deseja qualidade e eficiência (seção~\ref{cap02:sec:splat}).
Embora a representação de superfícies baseadas em \textit{splats} seja comum na
prática, muitos algoritmos de simplificação usa apenas o centro em
consideração;
a ideia é em um primeiro momento gerar uma superfície com uma densidade de
pontos que se ajuste a curvatura da superfície e em um processamento posterior,
converter estes pontos em \texit{splats} circulares ou elípticos. Em
contraste a esta abordagem, simplificação de superfícies baseada em \textit{splats}
levam em consideração toda a geometria do \textit{splat}.
 
Muitos algoritmos de simplificação~\cite{Rusinkiewicz2000,BotschW2002,EfficenteLOD2003} são baseados em
estruturas hierárquicas. Os pontos são organizados em uma estrutura de partição
espacial (capítulo~\ref{cap03}) e os \textit{splats} criados pela
análise local da superfície. Estas técnicas são simples e rápidas, mas como não
há uma estratégias de otimização mais elaborada, os resultados geralmente são
conservativos e tendem a produzir uma quantidade significativa de \textit{splats} redundantes.
A fim de produzir amostras com maior qualidade, usaremos uma abordagem gulosa
e incremental para renderização eficiente usando \textit{splats}, onde clusters são
criados adicionando vizinhos de acordo com métricas de erro definidas a diante (seções~\ref{cap05:sec:perpendicular}
e~\ref{cap05:sec:tangencial}).
 
\section{Clusterização Incremental}
Um cluster $\mathit{C_0}$ é construído adicionando-se 
sucessivamente os vizinhos mais próximos de $\mathbf{s}_j$ a partir de uma semente $\mathbf{s}_j \in \mathbf{\mathcal T}$  escolhida randomicamente. Este crescimento
incremental pára quando um limitante $\varphi_p$ (para erro perpendicular) e 
$\varphi_t$ (para o erro tangencial) é alcançado. O próximo cluster
$\mathit{C_1}$ é então construído seguindo o mesmo processo, com uma nova
semente escolhida na vizinhança de $\mathit{C_0}$.
Inicialmente, cada vizinho que possui erro perpendicular abaixo de $\varphi_p$ é
utilizado como possível candidato a membro do cluster. Com isso, o novo
centro $\mathbf{c}_m$ e normal $\mathbf{n}_m$ do \textit{splat}
$\mathbf{s}_m$ que representa o cluster são atualizados
(ver~\ref{cap05:sec:centroNormal}). Com $\mathbf{c}_m$ e $\mathbf{n}_m$,
podemos atualizar as extensões do \textit{splat} $\mathbf{s}_m$
(ver~\ref{cap05:sec:eixos}) e, consequentemente, computar o novo erro tangencial
$\mathbf{e}_t$. Caso este erro esteja acima de $\varphi_t$, a
configuração do último vizinho adicionado é estabelecida como o cluster final.
O processo continua até que todos os \textit{splats} de $\mathbf{\mathcal T}$
perteçam a algum cluster $\mathit C_i$.

\subsection{Centro e Normal}
\label{cap05:sec:centroNormal}
Para calcular o novo centro $\mathbf{c}_m$ e normal $\mathbf{n}_m$, utilizamos uma
soma ponderada pela área dos \textit{splat} de acordo com a
equação~\ref{eq:l21c} e~\ref{eq:l21n} (métrica $\mathbf{\mathit{L}}^2$). Assim, dado um conjunto
de \textit{splats}, o centro $\mathbf{c}_m$ e a normal $\mathbf{n}_m$ do novo
\textit{splat} podem ser definidos respectivamente como :

\begin{equation}
 \mathbf{c}_{m}  =  \frac{
 \sum_i{|\mathbf{s}_i|\cdot\mathbf{c}_i}}{\sum_i|\mathbf{s}_m|},
\end{equation}
\begin{equation}
 \mathbf{n}_{m}  =  \frac{
 \sum_i{|\mathbf{s}_i|\cdot\mathbf{n}_i}}{\sum_i|\mathbf{s}_m|}.
\end{equation}

\subsection{Eixos da Elipse}
\label{cap05:sec:eixos}
Similar ao método apresentado na Seção~\ref{cap04:sec:splats:l21}, a fim de obter os eixos da elipse
$\mathbf{s}_m$, projetamos $8$ pontos da borda das elipses $\mathbf{s}_i$ no
plano definido por $\mathbf{c}_m$ e $\mathbf{n}_m$. Aplicamos \textit{PCA} no
conjunto de pontos projetados $C^\prime $ para obter os autovalores $\lambda_1 \geq \lambda_2 \geq \lambda_3$ 
e autovetores unitários $v_1,v_2,v_3$. A direção dos eixos da elipse 
$\mathbf{s}_m$ é então definida pelos vetores $v_1$ e $v_2$.
Assumindo que a excentricidade da elipse é dada
por $\sqrt{ \frac{\lambda_1}{\lambda_2}}$, pode-se computar as dimensões dos eixos
principais como:
\begin{equation}
|t_m^1| = \sqrt{\lambda_1} \cdot \bar{\mathbf{e}},
\end{equation}
 \begin{equation}
|t_m^2| = \sqrt{\lambda_2} \cdot \bar{\mathbf{e}},
\end{equation}
onde
\begin{equation}
\bar{\mathbf{e}}  =  \frac{\max_{q \in C^\prime } \{
(\langle q,v_1 \rangle^2)\cdot\lambda_1 + (\langle q,v_2
\rangle^2)\cdot\lambda_2 \} }{\lambda_1\cdot\lambda_2}.
\end{equation}

\section{Erro Perpendicular}
\label{cap05:sec:perpendicular}

\begin{figure}[ht]
\centering
\includegraphics[width=15.0cm]{img/cap05/perpendicular2} 
\caption{O erro perpendicular mede a distância máxima dos \textit{splats}
$\mathbf{s}_i$ na direção perpendicular ao plano $\mathbf{P}_m$ definido por
pelo \textit{splat} $\mathbf{s}_m$}
\label{fig:merge_splats}
\end{figure}  

O problema de determinar a distância máxima de uma elipse
$\mathbf{s}_i$, do conjunto que está sendo agregado, ao plano da elipse
$\mathbf{s}_m$ (que passa a representar esse conjunto), não é tão imediato como no caso circular. Para
calcular a chamada distância perpendicular entre $\mathbf{s}_i$ e
$\mathbf{s}_m$, que notaremos como $\mathbf{\mathcal D}(i,m)$, precisamos executar o
seguinte processo. Seja:
\begin{equation}
v(\alpha) = t_{i}^{1} \cos(\alpha) + t_{i}^{2} \sin(\alpha) + c_{i},
\end{equation}
a representação paramétrica do contorno da elipse $\mathbf{s}_i$ e
${n}_m$ a normal ao plano $P_{m}$ da elipse $\mathbf{s}_m$. Para
maximizar em $\alpha$ a distância entre $v(\alpha)$ e $P_{m}$ precisamos 
resolver o seguinte problema de otimização:
\begin{equation}
\max_{\alpha \in [0,2\pi]}\langle v(\alpha)-c_{m},{n}_m\rangle = \langle t_{i}^{1},{n}_m \rangle
\cos(\alpha) + \langle t_{i}^{2},{n}_m \rangle \sin(\alpha) + \langle c_{i}-
c_{m},{n}_m \rangle.
\end{equation}
Para  resolver esse problema começamos igualando a zero a derivada da função
objetiva, o que determina que a solução procurada $\alpha_{max}$ deve satisfazer a:
\begin{equation}
\langle t_{i}^{2},{n}_m\rangle \cos(\alpha_{max}) - \langle t_{i}^{1},{n}_m
\rangle \sin(\alpha_{max}) &=& 0  \Longrightarrow \frac{\langle t_{i}^{2},{n}_m
\rangle}{\langle t_{i}^{1},{n}_m \rangle} &=& \tan(\alpha_{max}),
\end{equation}
onde:
\begin{align}
cos(\alpha_{max}) &= \pm \frac{ \langle t_{i}^{1},{n}_m
\rangle}{\sqrt{\langle t_{i}^{1},{n}_m \rangle^{2} + \langle t_{i}^{2},{n}_m
\rangle^{2}}} \\ \nonumber sin(\alpha_{max}) &= \pm
\frac{\langle t_{i}^{2},{n}_m\rangle}{\sqrt{\langle t_{i}^{1},{n}_m\rangle^{2} +
\langle t_{i}^{2},{n}_m\rangle^{2}}} \nonumber.
\end{align}

Para identificar inteiramente $\alpha_{max}$ resta apenas decidir acerca dos
sinais que aparecem nas expressões acima, o que significa distinguir  os casos 
de distância máxima e distância mínima a $P_{m}$. Isto é feito observando que os 
resultados acima nos permitem escrever $\mathbf{\mathcal D}(i,m)$ da seguinte
forma:
\begin{eqnarray*}
\mathbf{\mathcal D}(i,m) &=& \max_{sign \in \{-1,1\}}{|sign \cdot
\frac{\langle t_{i}^{1},{n}_m\rangle^{2} + \langle
t_{i}^{2},{n}_m\rangle^{2}}{\sqrt{ \langle t_{i}^{1},{n}_m\rangle^{2}
+\langle t_{i}^{2},{n}_m\rangle^{2}}}+\langle c_{i}- c_{m},{n}_m\rangle|} && \\
\mathbf{\mathcal D}(i,m) &=& \sqrt{\langle t_{i}^{1},{n}_m\rangle^{2} +
\langle t_{i}^{2},{n}_m\rangle^{2}}+|\langle c_{i}- c_{m},{n}_m\rangle|.\\
\end{eqnarray*}
Podemos então utilizar $\max_{i}\{\mathbf{\mathcal D}(i,m)\}$ como medida do erro
perpendicular. Alternativamente, podemos estender a definição de erro
perpendicular dada na seção~\ref{sec:SPT} para o caso circular, meramente
substituindo na equação~\ref{perpendicular:Circular}, $d_i$ por
$\sqrt{\langle t_{i}^{1},{n}_m\rangle^{2} +\langle
t_{i}^{2},{n}_m\rangle^{2}}$, o que nos permitirá obter:
\begin{eqnarray*}
\mathbf{e}_p  &=&  \max\{\langle c_i-c,n\rangle+ \sqrt{
\langle t_{i}^{1},{n}_m\rangle^{2} +\langle t_{i}^{2},{n}_m\rangle^{2}} \} -\\ 
&& \min\{\langle c_i-c,n\rangle - \sqrt{\langle t_{i}^{1},{n}_m\rangle^{2}
+\langle t_{i}^{2},{n}_m\rangle^{2}}
\}.
\end{eqnarray*}

\section{Erro Tangencial}
\label{cap05:sec:tangencial}
O erro tangencial mede a  diferença entre a elipse que representa o cluster
($\mathbf{s}_{m}$) e o conjunto ($\Gamma$) formado pelas projeções das elipses
que fazem parte do cluster sobre o plano de $\mathbf{s}_{m}$. Há duas maneiras
naturais de avaliar a diferença entre dois conjuntos planares. 
A primeira é dada pela área da diferença simétrica entre os conjuntos. 
No caso, como $\mathbf{s}_{m}$ contem $\Gamma$, essa diferença é simplesmente
$\mathbf{s}_{m}-\Gamma$. A segunda pela maior distância de um ponto de um
conjunto a outro. Como $\Gamma \subseteq \mathbf{s}_{m}$, podemos nos restringir 
a encontrar o ponto $q$ em $\mathbf{s}_{m}$ mais afastado de $\Gamma$. 
Para obter computacionalmente a área de $\mathbf{s}_{m}
-\Gamma$ ($\mathbf{\mathcal A}(\mathbf{s}_{m}-\Gamma$)), pensamos em duas
estratégias :

\begin{figure}[ht]
\centering
\begin{tabular}{cc}
\begin{minipage}[b]{0.4\linewidth}
  	\centering
	\includegraphics[width=1.00\linewidth]{img/cap05/grade4}\\[0cm](a)
\end{minipage}
\end{tabular}
\caption{Segunda proposta de erro tangencial. Imegir as elipses e calcular a
diferença de área pela grade regular.}
\label{fig:grade}
\end{figure}
\begin{enumerate}
  \item 
 \item {A primeira visa obter essa área de forma exata. De fato, identificando
 os pontos extremos de cada elipse em relação a uma das coordenadas e os ordenando segundo ela, 
 podemos por um algoritmo de varredura de linhas identificar as interseções dos contornos das 
 elipses de $\Gamma$ e, a partir delas $\mathbf{\mathcal
 A}(\mathbf{s}_{m}-\Gamma$). Esse procedimento, entretanto, tem uma
 complexidade que torna impraticável a sua utilização para nossos propósitos.
 Para concluir isso, basta considerar que ele é $O(n_{x} \log{n_{x}})$, onde $
 n_{x}$ é o número de interseções entre elipses de $\Gamma$, o qual já é quadrático
 no número dessas elipses. Além disso, o simples cômputo de uma interseção entre duas elipses em posição genérica já envolve 
 a resolução de uma equação do quarto grau. Assim, pretender encontrar o valor exato de 
$\mathbf{\mathcal A}(\mathbf{s}_{m}-\Gamma$) é uma tarefa impraticável. }

 \item { A segunda forma busca uma solução aproximada ao imergir as elipses envolvidas numa malha regular e determinar a
 situação de pertinência em relação a $\mathbf{s}_{m}$ e $\Gamma$ do centro de cada
 célula. Uma célula cujo centro pertence a $\mathbf{s}_{m}$ e não a $\Gamma$, contribui
 com sua área para o cômputo de $\mathbf{\mathcal A}(\mathbf{s}_{m}-\Gamma$). A
 determinação da pertinência com relação a todas as elipses de $\Gamma$, precisando ser efetuada para um
 número de pontos quadrático na resolução da malha, prejudica a performance
 dessa alternativa. Isto obriga que se empregue uma malha muito grosseira ou
 que se limite o número de elipses sendo agregadas, tornando, portanto, esta opção
 também não inteiramente satisfatória.}
\end{enumerate}

Tendo em vista as dificuldades apontadas acima na obtenção da área de
$\mathbf{s}_{m}-\Gamma$ nos concentramos em obter o erro tangencial via uma
aproximação computacionalmente viável da $dist(\mathbf{s}_{m},\Gamma$), a distância a
$\Gamma$ do ponto de $s_{m}$ mais afastado dele. A determinação de
$dist(\mathbf{s}_{m},\Gamma$) fica facilitada se assumirmos que o ponto de $\mathbf{s}_{m}$ mais
distante de $\Gamma$ estiver na sua borda. Isso certamente é verdade se o
número de elipses em $\Gamma$ for igual a $2$ e em casos reais, devido a
própria limitação do tamanho do cluster e do fato do próprio processo de
expansão que gera os clusters não fazer curvas acentuadas. Notamos que essa suposição não
causou distorções acentuadas no cálculo do erro tangencial. Se podemos limitar
a busca do ponto mais distante de $\Gamma$ a borda de $\mathbf{s}_{m}$,
podemos aproximar $dist(\mathbf{s}_{m},\Gamma$) de forma aceitável e com custo
computacional adequado, da seguinte forma:

\begin{itemize}
\item {O contorno da elipse $\mathbf{s}_m$ que
representa o cluster é discretizado num conjunto, $\mathbf{\mathcal C} =
\{p_1,\ldots,p_8\}$, contendo $8$ de seus pontos. Especificamente,
são aqueles que definem com o centro da elipse raias que fazem com o eixo maior um ângulo múltiplo de $45^{o}$.  }
\item {Seja $\mathbf{s}_i$ uma elipse do conjunto $\mathbf{\mathcal T} =
\{\mathbf{s}_1, \ldots,\mathbf{s}_n\}$, que está sendo condensado, e $\mathbf{s}_i^\prime$ uma
elipse do conjunto $\mathbf{\mathcal T}^\prime = \{\mathbf{s}_i^\prime,
\ldots,\mathbf{s}_n^\prime\}$\ de elipses projetadas sobre o plano definido
por $\mathbf{s}_m$. A distância de cada um dos pontos ($p_{k} \in $ $\mathbf{\mathcal C}$) em que se discretiza 
$\mathbf{s}_m$ a $\mathbf{s}_i^\prime$  $-$ que notaremos por
$dist(p_{k},\mathbf{s}_i^\prime)$ $-$ é obtida de forma aproximada da forma
indicada abaixo. Os elementos referidos no texto a seguir estão representados
na Figura~\ref{fig:merge_splats}.}
\end{itemize}
\begin{figure}[ht]
\centering
%\begin{tabular}{cc}
\begin{minipage}[b]{0.43\linewidth}
  	\centering
	\includegraphics[width=1.00\linewidth]{img/cap05/tangencial1}\\[0cm](a)
\end{minipage}
   \hfill
\begin{minipage}[b]{0.43\linewidth}
   	\centering
	\includegraphics[width=1.00\linewidth]{img/cap05/tangencial2}\\[0cm](b)
\end{minipage}
\\
\centering
\begin{minipage}[b]{0.4\linewidth}
  	\centering
	\includegraphics[width=1.00\linewidth]{img/cap05/raias}\\[0cm](c)
	\label{fig:raia}
\end{minipage}
%\end{tabular}
\caption{ Distância aproximada de uma elipse $\mathbf{s}_i^\prime$ do conjunto
das elipses projetadas $\mathbf{\mathcal T}^\prime$ ao contorno de $\mathbf{s}_m$
discretizado em $8$ pontos.$(b)$ Quando a projeção nãos está no segmento
delimitado por $\overline{q_1q_2}$, o erro tangencial é
tomado com sendo a distância de $p_{k}$ a $q_1$. O segmento em vermelho representa o erro tangencial. Embaixo,
ilustra a discretização de $\mathbf{s}_m$.}
\label{fig:merge_splats}
\end{figure}  

\begin{enumerate}
\item {No caso óbvio em que $p_{k} \in  \mathbf{s}_i^\prime$, teremos
$dist(p_{k}, \mathbf{s}_i^\prime) = 0 $.}

\item {Caso contrário, considere o segmento de reta delimitado pelo ponto $q_{1}$,  
onde a raia $[ c_{i}, p_{k}]$ corta a elipse  $\mathbf{s}_i^\prime$, e $q_{2}$ sendo a extremidade do eixo 
maior de $\mathbf{s}_i^\prime$  que está mais próxima de $p_{k}$.}

\item {Computa-se a distância de  $p_{k}$ a $[q_{1}, q_{2}]$ e usa-se essa distância como 
aproximação de $dist(p_{k}, \mathbf{s}_i^\prime))$.}
\end{enumerate}

Utilizando a distância aproximada definida acima, se obtém para cada $p_{k}$
sua distância ao conjunto de elipses $\mathbf{\mathcal T}^\prime$ $-$ dado por
$ \min_{ \mathbf{s}_i^\prime \in  \mathbf{\mathcal T}^\prime}
(dist_{p_k \in \mathbf{\mathcal C}}(p_{k}, \mathbf{s}_i^\prime))$. O erro
tangencial será finalmente obtido tomando-se a maior dessas distâncias. Ele pode, então, ser expresso por:


\begin{eqnarray}
e_t &=& \displaystyle\max  \{ \min_{ \mathbf{s}_i^\prime \in  \mathbf{\mathcal T}^\prime}
(dist_{p_k \in \mathbf{\mathcal C}}(p_{k}, \mathbf{s}_i^\prime)) \}\\\nonumber 
\end{eqnarray}

\section{Resultados}
A Tabela~\ref{cap05:tabelasimplificacao} expõe os resultados das simplificações de $3$ modelos. O
limitante para erro perpendicular $\varphi_p$ foi tomado como sendo o dobro da
distância do vizinho mais próximo à semente: $2 \cdot \min_{p \in \mathbf{\mathcal{N}}_k(\mathbf{s}_{seed})}dist(\mathbf{s}_{seed},p)\quad$. 
O limitante tangencial $\varphi_t$ foi
tomado como sendo a dimensão do eixo menor da semente $||\mathbf{t}_{seed}^1||$.
\begin{table}[ht]
\begin{center}
\begin{tabular}{lcc}
\hline
Modelo  & N° \textit{Splats} Originais &
N° \textit{Splats} Simplificação
\\
\hline
\textit{Bunny} 	   & $139990$ & $11258$\\
\hline
\textit{Armadillo} & $172974$ & $11964$\\
\hline
\textit{Dragon}    & $437645$ & $37959$\\
\hline
\end{tabular}
\end{center}
\caption{Número de \textit{splats} após simplificação usando nosso
algoritmo.}
\label{cap05:tabelasimplificacao}
\end{table}

\begin{figure}[ht]
\centering
\begin{tabular}{cc}
\begin{minipage}[b]{0.4\linewidth}
  	\centering
	\includegraphics[width=1.00\linewidth]{img/cap05/bunnyTotalpdf}\\[0cm](a)
\end{minipage}
   \hfill
&\begin{minipage}[b]{0.4\linewidth}
   	\centering
	\includegraphics[width=1.00\linewidth]{img/cap05/bunnySpdf}\\[0cm](b)
\end{minipage}
\\
\begin{minipage}[b]{0.4\linewidth}
	\centering
	\includegraphics[width=1.00\linewidth]{img/cap05/ArmadilhoTotal}\\[0cm](c)
\end{minipage}  
  \hfill
\centering
&\begin{minipage}[b]{0.4\linewidth}
    \centering
    \includegraphics[width=1.00\linewidth]{img/cap05/ArmadilhoS}\\[0cm](d)
\end{minipage}
\\
\begin{minipage}[b]{0.4\linewidth}
	\centering
	\includegraphics[width=1.00\linewidth]{img/cap05/dragontotal}\\[0cm](e)
\end{minipage}  
  \hfill
\centering
&\begin{minipage}[b]{0.4\linewidth}
    \centering
    \includegraphics[width=1.00\linewidth]{img/cap05/dragonS}\\[0cm](f)
\end{minipage}
\end{tabular}
\caption{Modelos aprensetados na
tabela~\ref{cap05:tabelasimplificacao}.\textbf{(a)} Modelo \textit{Bunny}
original: $139990$. \textbf{(b)} \textit{Bunny} simplificado: $11258$. \textbf{(c)} Modelo \textit{Armadillo} original: $172974$. \textbf{(d)} Modelo simplificado: $11964$.\textbf{(e)} Modelo \textit{Dragon} original: $437645$
\textbf{(f)} Modelo simplificado $37959$.}
\label{fig:pauly}
\end{figure}

Foi usada uma \textit{K-D Tree} para computar os $k-$vizinhos mais próximos da
semente. Foram usados $32$ vizinhos mais próximos, mas este número é dependendente
da densidade do modelo; sendo assim, o tamanho do cluster fica limitado ao máximo de
$32$.

\section{Discussão}
Este capítulo apresentou um algoritmo de simplificação baseado em
\textit{splats} bem como duas extensões de métricas de erro para o caso
elíptico, o erro perpendicular e o tangencial. O erro perpendicular fornece uma
medida de variância na direção da normal, permitindo distinguir regiões com
curvatura acentuada de regiões planares. O erro tangencial nos fornece uma
medida de cobertura, evitando que os cluster cresçam de forma descontrolada e, consequentemente,
cubram áreas desnecessárias.

